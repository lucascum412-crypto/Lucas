<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cyber Storm - 射擊升級版</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Courier New', Courier, monospace;
            touch-action: none;
        }

        canvas {
            display: block;
            cursor: none;
        }

        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #00ff00;
            font-size: 20px;
            text-shadow: 0 0 5px #00ff00;
            pointer-events: none;
            z-index: 10;
        }

        .bar-container {
            width: 200px;
            height: 20px;
            border: 2px solid #00ff00;
            margin-bottom: 10px;
            background: rgba(0, 50, 0, 0.5);
            position: relative;
        }

        #hpBar {
            width: 100%;
            height: 100%;
            background-color: #00ff00;
            transition: width 0.2s;
        }

        #bombDisplay {
            margin-top: 5px;
            color: #ff00ff;
            text-shadow: 0 0 5px #ff00ff;
        }

        #startScreen, #gameOverScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 20;
        }

        h1 {
            font-size: 40px;
            color: #00ff00;
            text-transform: uppercase;
            text-shadow: 0 0 20px #00ff00;
            margin-bottom: 10px;
        }

        p {
            font-size: 18px;
            color: #aaa;
            text-align: center;
            line-height: 1.5;
        }

        button {
            margin-top: 30px;
            padding: 15px 40px;
            font-size: 24px;
            background: transparent;
            color: #00ff00;
            border: 2px solid #00ff00;
            cursor: pointer;
            font-family: inherit;
            text-transform: uppercase;
            box-shadow: 0 0 15px #00ff00;
            transition: 0.2s;
        }

        button:hover {
            background: #00ff00;
            color: black;
        }

        .hidden { display: none !important; }
        
        /* 手機專用炸彈按鈕 */
        #mobileBombBtn {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 0, 255, 0.3);
            border: 2px solid #ff00ff;
            color: #fff;
            display: none; /* JS決定是否顯示 */
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 14px;
            z-index: 15;
            user-select: none;
        }
        #mobileBombBtn:active {
            background: rgba(255, 0, 255, 0.8);
        }
    </style>
</head>
<body>

<div id="ui">
    <div class="bar-container">
        <div id="hpBar"></div>
    </div>
    <div>SCORE: <span id="scoreVal">0</span></div>
    <div id="bombDisplay">BOMBS: <span id="bombVal">3</span> (按空白鍵/點擊)</div>
</div>

<div id="mobileBombBtn">BOMB</div>

<div id="startScreen">
    <h1>Cyber Storm</h1>
    <p>滑鼠/手指移動戰機<br>自動射擊<br>左鍵/空白鍵 施放炸彈<br>收集 [P] 升級武器, [H] 補血</p>
    <button id="startBtn">開始任務</button>
</div>

<div id="gameOverScreen" class="hidden">
    <h1>任務失敗</h1>
    <p>最終得分: <span id="finalScore">0</span></p>
    <button id="restartBtn">重新部署</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    // --- 音效系統 (AudioContext) ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx;

    function initAudio() {
        if (!audioCtx) audioCtx = new AudioContext();
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    function playSound(type) {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        const now = audioCtx.currentTime;
        
        if (type === 'shoot') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(800, now);
            osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
            gain.gain.setValueAtTime(0.05, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(now);
            osc.stop(now + 0.1);
        } else if (type === 'explosion') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(100, now);
            osc.frequency.exponentialRampToValueAtTime(0.01, now + 0.3);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            osc.start(now);
            osc.stop(now + 0.3);
        } else if (type === 'powerup') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(600, now);
            osc.frequency.linearRampToValueAtTime(1200, now + 0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.2);
            osc.start(now);
            osc.stop(now + 0.2);
        } else if (type === 'bomb') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(200, now);
            osc.frequency.exponentialRampToValueAtTime(50, now + 1);
            gain.gain.setValueAtTime(0.3, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 1);
            osc.start(now);
            osc.stop(now + 1);
        }
    }

    // --- 遊戲核心 ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // UI 元素
    const scoreEl = document.getElementById('scoreVal');
    const bombEl = document.getElementById('bombVal');
    const hpBar = document.getElementById('hpBar');
    const startScreen = document.getElementById('startScreen');
    const gameOverScreen = document.getElementById('gameOverScreen');
    const finalScoreEl = document.getElementById('finalScore');
    const mobileBombBtn = document.getElementById('mobileBombBtn');

    let w, h;
    let gameLoop;
    let isGameRunning = false;
    let frame = 0;
    let score = 0;
    let shakeTimer = 0;

    // 檢測手機
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    if(isMobile) mobileBombBtn.style.display = 'flex';

    // 玩家狀態
    const player = {
        x: 0, y: 0, r: 15,
        hp: 100, maxHp: 100,
        color: '#00ff00',
        weaponLevel: 1,
        bombs: 3,
        lastShot: 0,
        fireRate: 8 // 越小越快
    };

    // 實體陣列
    let bullets = [];
    let enemies = [];
    let particles = [];
    let items = [];
    let textEffects = [];

    // 初始化畫布
    function resize() {
        w = canvas.width = window.innerWidth;
        h = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // 輸入控制
    document.addEventListener('mousemove', e => {
        if (!isGameRunning) return;
        player.x = e.clientX;
        player.y = e.clientY; // 現在可以上下移動
    });

    document.addEventListener('touchmove', e => {
        if (!isGameRunning) return;
        e.preventDefault();
        player.x = e.touches[0].clientX;
        player.y = e.touches[0].clientY - 50; // 手指稍微上方一點
    }, {passive: false});

    // 炸彈觸發
    function useBomb() {
        if (!isGameRunning || player.bombs <= 0) return;
        player.bombs--;
        bombEl.innerText = player.bombs;
        playSound('bomb');
        
        // 炸彈特效
        shakeTimer = 20;
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, w, h);
        
        // 清除所有敵人子彈(這裡沒做敵人子彈，所以是全清敵人)
        enemies.forEach(e => {
            createExplosion(e.x, e.y, e.color, e.r * 2);
            score += 50;
        });
        enemies = [];
        bullets = []; // 也清空自己的子彈避免視覺混亂
        
        scoreEl.innerText = score;
    }

    document.addEventListener('keydown', e => {
        if (e.code === 'Space') useBomb();
    });
    
    document.addEventListener('click', (e) => {
        // 在電腦版點擊發射炸彈，但在手機版點擊按鈕
        if(!isGameRunning) return;
        if(!isMobile && e.target.tagName !== 'BUTTON') useBomb();
    });

    mobileBombBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        useBomb();
    });

    // 開始遊戲
    document.getElementById('startBtn').addEventListener('click', startGame);
    document.getElementById('restartBtn').addEventListener('click', startGame);

    function startGame() {
        initAudio();
        isGameRunning = true;
        score = 0;
        frame = 0;
        player.hp = 100;
        player.weaponLevel = 1;
        player.bombs = 3;
        player.x = w / 2;
        player.y = h - 100;
        
        enemies = [];
        bullets = [];
        particles = [];
        items = [];
        textEffects = [];
        
        startScreen.classList.add('hidden');
        gameOverScreen.classList.add('hidden');
        scoreEl.innerText = '0';
        bombEl.innerText = '3';
        updateHpBar();
        
        cancelAnimationFrame(gameLoop);
        loop();
    }

    function updateHpBar() {
        hpBar.style.width = (player.hp / player.maxHp * 100) + '%';
        if (player.hp <= 30) hpBar.style.backgroundColor = 'red';
        else hpBar.style.backgroundColor = '#00ff00';
    }

    function createExplosion(x, y, color, count = 10) {
        playSound('explosion');
        for(let i=0; i<count; i++) {
            particles.push({
                x, y,
                vx: (Math.random() - 0.5) * 10,
                vy: (Math.random() - 0.5) * 10,
                life: 1.0,
                color: color,
                size: Math.random() * 3 + 1
            });
        }
    }

    function spawnEnemy() {
        const typeRand = Math.random();
        let enemy = {
            x: Math.random() * w,
            y: -50,
            r: 20,
            hp: 2,
            speed: 3,
            color: '#ff0000',
            score: 10,
            type: 'basic'
        };

        if (score > 500 && typeRand > 0.7) {
            // 快速衝刺型
            enemy.color = '#ffff00';
            enemy.speed = 6;
            enemy.r = 15;
            enemy.hp = 1;
            enemy.score = 20;
            enemy.type = 'rusher';
        } else if (score > 1000 && typeRand > 0.9) {
            // 坦克型
            enemy.color = '#8800ff';
            enemy.speed = 1.5;
            enemy.r = 40;
            enemy.hp = 15;
            enemy.score = 50;
            enemy.type = 'tank';
        }

        enemies.push(enemy);
    }

    function fireBullet() {
        playSound('shoot');
        const v = 15;
        
        // 中間
        bullets.push({x: player.x, y: player.y - 20, vx: 0, vy: -v, color: '#00ffff'});

        if (player.weaponLevel >= 2) {
            bullets.push({x: player.x - 10, y: player.y - 10, vx: -2, vy: -v*0.9, color: '#00ffff'});
            bullets.push({x: player.x + 10, y: player.y - 10, vx: 2, vy: -v*0.9, color: '#00ffff'});
        }
        if (player.weaponLevel >= 3) {
             bullets.push({x: player.x - 20, y: player.y, vx: -5, vy: -v*0.8, color: '#0088ff'});
             bullets.push({x: player.x + 20, y: player.y, vx: 5, vy: -v*0.8, color: '#0088ff'});
        }
    }

    function loop() {
        if (!isGameRunning) return;

        // 螢幕震動處理
        let shakeX = 0, shakeY = 0;
        if (shakeTimer > 0) {
            shakeX = (Math.random() - 0.5) * 10;
            shakeY = (Math.random() - 0.5) * 10;
            shakeTimer--;
        }

        ctx.setTransform(1, 0, 0, 1, shakeX, shakeY);
        
        // 背景拖影
        ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
        ctx.fillRect(-10, -10, w+20, h+20);

        // 玩家自動射擊
        if (frame % player.fireRate === 0) fireBullet();

        // 繪製玩家
        ctx.shadowBlur = 15;
        ctx.shadowColor = player.color;
        
        // 戰機形狀 (三角形)
        ctx.fillStyle = player.color;
        ctx.beginPath();
        ctx.moveTo(player.x, player.y - 20);
        ctx.lineTo(player.x - 15, player.y + 15);
        ctx.lineTo(player.x, player.y + 5);
        ctx.lineTo(player.x + 15, player.y + 15);
        ctx.closePath();
        ctx.fill();

        // 核心亮點
        ctx.fillStyle = '#fff';
        ctx.beginPath();
        ctx.arc(player.x, player.y, 5, 0, Math.PI*2);
        ctx.fill();

        ctx.shadowBlur = 0;

        // 更新子彈
        ctx.fillStyle = '#00ffff';
        for (let i = bullets.length - 1; i >= 0; i--) {
            let b = bullets[i];
            b.x += b.vx;
            b.y += b.vy;
            ctx.fillRect(b.x - 2, b.y - 5, 4, 10);
            if (b.y < -50) bullets.splice(i, 1);
        }

        // 生成敵人
        let spawnRate = 40;
        if (score > 1000) spawnRate = 30;
        if (score > 3000) spawnRate = 20;
        
        if (frame % spawnRate === 0) spawnEnemy();

        // 更新敵人
        for (let i = enemies.length - 1; i >= 0; i--) {
            let e = enemies[i];
            e.y += e.speed;
            
            // 繪製敵人
            ctx.shadowBlur = 10;
            ctx.shadowColor = e.color;
            ctx.strokeStyle = e.color;
            ctx.lineWidth = 3;
            
            ctx.beginPath();
            if (e.type === 'tank') {
                ctx.rect(e.x - e.r, e.y - e.r, e.r*2, e.r*2);
            } else if (e.type === 'rusher') {
                ctx.moveTo(e.x, e.y + e.r);
                ctx.lineTo(e.x - e.r, e.y - e.r);
                ctx.lineTo(e.x + e.r, e.y - e.r);
                ctx.closePath();
            } else {
                ctx.arc(e.x, e.y, e.r, 0, Math.PI * 2);
            }
            ctx.stroke();
            
            // 繪製內部填充 (HP顯示)
            ctx.fillStyle = e.color;
            ctx.globalAlpha = 0.3;
            ctx.fill();
            ctx.globalAlpha = 1.0;
            ctx.shadowBlur = 0;

            // 碰撞: 子彈擊中敵人
            for (let j = bullets.length - 1; j >= 0; j--) {
                let b = bullets[j];
                let dist = Math.hypot(b.x - e.x, b.y - e.y);
                if (dist < e.r + 5) {
                    e.hp--;
                    bullets.splice(j, 1);
                    // 擊中特效
                    createExplosion(b.x, b.y, '#fff', 2);
                    
                    if (e.hp <= 0) {
                        createExplosion(e.x, e.y, e.color, 15);
                        score += e.score;
                        scoreEl.innerText = score;
                        shakeTimer = 5;
                        
                        // 掉落物品機率
                        if (Math.random() < 0.1) {
                            items.push({
                                x: e.x, y: e.y, 
                                type: Math.random() > 0.3 ? 'P' : 'H', // P=Power, H=Heal
                                vy: 2
                            });
                        }
                        
                        enemies.splice(i, 1);
                    }
                    break;
                }
            }
            
            // 碰撞: 敵人撞玩家
            if (enemies[i]) { // 如果敵人還沒死
                let pDist = Math.hypot(player.x - e.x, player.y - e.y);
                if (pDist < player.r + e.r) {
                    player.hp -= 20;
                    updateHpBar();
                    createExplosion(player.x, player.y, '#ff0000', 20);
                    shakeTimer = 15;
                    enemies.splice(i, 1);
                    
                    if (player.hp <= 0) {
                        isGameRunning = false;
                        finalScoreEl.innerText = score;
                        gameOverScreen.classList.remove('hidden');
                    }
                } else if (e.y > h + 50) {
                    enemies.splice(i, 1);
                }
            }
        }

        // 更新道具
        for (let i = items.length - 1; i >= 0; i--) {
            let item = items[i];
            item.y += item.vy;
            
            ctx.font = 'bold 20px Arial';
            ctx.fillStyle = item.type === 'P' ? '#00ffff' : '#00ff00';
            ctx.fillText(item.type, item.x, item.y);
            ctx.strokeStyle = '#fff';
            ctx.strokeText(item.type, item.x, item.y);
            
            // 吃到道具
            let dist = Math.hypot(player.x - item.x, player.y - item.y);
            if (dist < 30) {
                playSound('powerup');
                if (item.type === 'P') {
                    player.weaponLevel = Math.min(player.weaponLevel + 1, 3);
                    textEffects.push({x: player.x, y: player.y, text: "POWER UP!", life: 60});
                } else {
                    player.hp = Math.min(player.hp + 30, 100);
                    updateHpBar();
                    textEffects.push({x: player.x, y: player.y, text: "HEAL", life: 60});
                }
                items.splice(i, 1);
            } else if (item.y > h) {
                items.splice(i, 1);
            }
        }

        // 更新粒子
        for (let i = particles.length - 1; i >= 0; i--) {
            let p = particles[i];
            p.x += p.vx;
            p.y += p.vy;
            p.life -= 0.05;
            ctx.fillStyle = p.color;
            ctx.globalAlpha = p.life;
            ctx.fillRect(p.x, p.y, p.size, p.size);
            if (p.life <= 0) particles.splice(i, 1);
        }
        ctx.globalAlpha = 1.0;

        // 文字特效
        for (let i = textEffects.length - 1; i >= 0; i--) {
            let t = textEffects[i];
            t.y -= 1;
            t.life--;
            ctx.fillStyle = `rgba(255, 255, 255, ${t.life/60})`;
            ctx.font = '20px Arial';
            ctx.fillText(t.text, t.x - 30, t.y);
            if (t.life <= 0) textEffects.splice(i, 1);
        }

        frame++;
        gameLoop = requestAnimationFrame(loop);
    }
</script>

</body>
</html>